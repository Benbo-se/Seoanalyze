module.exports=[66287,(e,t,r)=>{class s{constructor(e,t={}){this.serviceName=e,this.config={failureThreshold:t.failureThreshold||5,failureRate:t.failureRate||.3,recoveryTimeout:t.recoveryTimeout||12e4,monitoringWindow:t.monitoringWindow||6e4,halfOpenMaxCalls:t.halfOpenMaxCalls||3,...t},this.state="CLOSED",this.failures=0,this.successes=0,this.lastFailureTime=null,this.nextAttempt=null,this.halfOpenCalls=0,this.callHistory=[],this.windowStart=Date.now(),console.log(`üõ°Ô∏è Circuit Breaker initialized for ${e}`)}async call(e,...t){if("OPEN"===this.state){if(Date.now()<this.nextAttempt)throw Error(`Circuit breaker OPEN for ${this.serviceName}. Next attempt at ${new Date(this.nextAttempt).toLocaleTimeString()}`);this.state="HALF_OPEN",this.halfOpenCalls=0,console.log(`üîÑ Circuit breaker ${this.serviceName}: OPEN ‚Üí HALF_OPEN`)}if("HALF_OPEN"===this.state&&this.halfOpenCalls>=this.config.halfOpenMaxCalls)throw Error(`Circuit breaker HALF_OPEN limit exceeded for ${this.serviceName}`);let r=Date.now();try{let s=await e(...t);return this.onSuccess(r),s}catch(e){throw this.onFailure(r,e),e}}onSuccess(e){let t=Date.now()-e;this.addToHistory(!0,t),"HALF_OPEN"===this.state&&(this.halfOpenCalls++,this.successes++,this.successes>=this.config.halfOpenMaxCalls&&(this.state="CLOSED",this.failures=0,this.successes=0,this.halfOpenCalls=0,console.log(`‚úÖ Circuit breaker ${this.serviceName}: HALF_OPEN ‚Üí CLOSED (recovered)`))),"CLOSED"===this.state&&(this.failures=0)}onFailure(e,t){let r=Date.now()-e;if(this.addToHistory(!1,r,t.message),this.failures++,this.lastFailureTime=Date.now(),"HALF_OPEN"===this.state){this.state="OPEN",this.nextAttempt=Date.now()+this.config.recoveryTimeout,this.successes=0,this.halfOpenCalls=0,console.log(`‚ùå Circuit breaker ${this.serviceName}: HALF_OPEN ‚Üí OPEN (failed recovery)`);return}this.shouldTrip()&&(this.state="OPEN",this.nextAttempt=Date.now()+this.config.recoveryTimeout,console.log(`üî¥ Circuit breaker ${this.serviceName}: CLOSED ‚Üí OPEN (${this.getFailureRate()}% failure rate)`))}shouldTrip(){return"CLOSED"===this.state&&!!(this.failures>=this.config.failureThreshold||this.getFailureRate()>=100*this.config.failureRate&&this.getTotalCalls()>=10)}addToHistory(e,t,r=null){let s=Date.now();this.callHistory=this.callHistory.filter(e=>s-e.timestamp<this.config.monitoringWindow),this.callHistory.push({timestamp:s,success:e,duration:t,error:r})}getStats(){let e=Date.now(),t=this.callHistory.filter(t=>e-t.timestamp<this.config.monitoringWindow),r=t.length,s=t.filter(e=>e.success).length,a=r-s,i=r>0?Math.round(t.reduce((e,t)=>e+t.duration,0)/r):0;return{serviceName:this.serviceName,state:this.state,totalCalls:r,successfulCalls:s,failedCalls:a,failureRate:Math.round(100*(r>0?a/r*100:0))/100,avgResponseTime:i,lastFailure:this.lastFailureTime?new Date(this.lastFailureTime).toISOString():null,nextAttempt:this.nextAttempt?new Date(this.nextAttempt).toISOString():null,config:this.config}}getFailureRate(){let e=this.getTotalCalls();return 0===e?0:Math.round(this.callHistory.filter(e=>!e.success).length/e*1e4)/100}getTotalCalls(){let e=Date.now();return this.callHistory.filter(t=>e-t.timestamp<this.config.monitoringWindow).length}reset(){this.state="CLOSED",this.failures=0,this.successes=0,this.halfOpenCalls=0,this.callHistory=[],this.lastFailureTime=null,this.nextAttempt=null,console.log(`üîÑ Circuit breaker ${this.serviceName} manually reset`)}forceOpen(){this.state="OPEN",this.nextAttempt=Date.now()+this.config.recoveryTimeout,console.log(`‚ö†Ô∏è Circuit breaker ${this.serviceName} manually opened`)}}t.exports={CircuitBreaker:s,CircuitBreakerManager:new class{constructor(){this.breakers=new Map}get(e,t={}){return this.breakers.has(e)||this.breakers.set(e,new s(e,t)),this.breakers.get(e)}getAllStats(){let e={};for(let[t,r]of this.breakers.entries())e[t]=r.getStats();return e}reset(e=null){if(e){let t=this.breakers.get(e);t&&t.reset()}else for(let e of this.breakers.values())e.reset()}}}},53915,e=>{"use strict";e.s(["handler",()=>k,"patchFetch",()=>A,"routeModule",()=>x,"serverHooks",()=>y,"workAsyncStorage",()=>N,"workUnitAsyncStorage",()=>S],53915);var t=e.i(47909),r=e.i(74017),s=e.i(96250),a=e.i(59756),i=e.i(61916),n=e.i(69741),l=e.i(16795),o=e.i(87718),c=e.i(73895),u=e.i(47587),h=e.i(66012),d=e.i(70101),p=e.i(26937),f=e.i(10372),g=e.i(93695);e.i(52474);var m=e.i(220);e.s(["GET",()=>v,"POST",()=>O,"runtime",()=>R],88744);var C=e.i(89171);let{CircuitBreakerManager:w}=e.r(66287),R="nodejs";async function v(e){try{let{searchParams:t}=new URL(e.url),r=t.get("service");if("true"===t.get("test")&&r){let e=w.get(r,{failureThreshold:3,recoveryTimeout:5e3}),t=[];for(let r=0;r<10;r++){try{let s=await e.call(async()=>{if([2,3,4].includes(r))throw Error(`Simulerat API fel - call ${r+1}`);return await new Promise(e=>setTimeout(e,100*Math.random()+50)),{success:!0,data:`API response ${r+1}`}});t.push({call:r+1,success:!0,result:s.data,circuitState:e.getStats().state,timestamp:new Date().toISOString()})}catch(s){t.push({call:r+1,success:!1,error:s.message,circuitState:e.getStats().state,timestamp:new Date().toISOString()})}await new Promise(e=>setTimeout(e,50))}let s=e.getStats();return C.NextResponse.json({success:!0,service:r,testResults:t,finalStats:s,summary:{totalCalls:t.length,successfulCalls:t.filter(e=>e.success).length,failedCalls:t.filter(e=>!e.success).length,finalCircuitState:s.state}})}if(r){let e=w.get(r).getStats();return C.NextResponse.json({success:!0,service:r,stats:e})}let s=w.getAllStats();return C.NextResponse.json({success:!0,circuitBreakers:s,summary:{totalServices:Object.keys(s).length,openCircuits:Object.values(s).filter(e=>"OPEN"===e.state).length,halfOpenCircuits:Object.values(s).filter(e=>"HALF_OPEN"===e.state).length,closedCircuits:Object.values(s).filter(e=>"CLOSED"===e.state).length}})}catch(e){return console.error("Circuit Breaker API error:",e),C.NextResponse.json({error:"Misslyckades att h√§mta circuit breaker status",message:e.message},{status:500})}}async function O(e){try{let t=await e.json().catch(()=>null);if(!t?.service)return C.NextResponse.json({error:"Service name kr√§vs"},{status:400});let{service:r,action:s,config:a={}}=t;if("reset"===s)return w.reset(r),console.log(`üîÑ Circuit breaker reset f\xf6r ${r}`),C.NextResponse.json({success:!0,message:`Circuit breaker reset f\xf6r ${r}`,service:r,timestamp:new Date().toISOString()});if("configure"===s){let e=w.get(r,a);return console.log(`‚öôÔ∏è Circuit breaker konfigurerad f\xf6r ${r}:`,a),C.NextResponse.json({success:!0,message:`Circuit breaker konfigurerad f\xf6r ${r}`,service:r,config:e.config,stats:e.getStats(),timestamp:new Date().toISOString()})}if("force-open"===s){let e=w.get(r);return e.forceOpen(),console.log(`‚ö†Ô∏è Circuit breaker manuellt \xf6ppnad f\xf6r ${r}`),C.NextResponse.json({success:!0,message:`Circuit breaker \xf6ppnad f\xf6r ${r}`,service:r,stats:e.getStats(),timestamp:new Date().toISOString()})}return C.NextResponse.json({error:"Ok√§nd action. Anv√§nd: reset, configure, eller force-open"},{status:400})}catch(e){return console.error("Circuit Breaker config error:",e),C.NextResponse.json({error:"Misslyckades att konfigurera circuit breaker",message:e.message},{status:500})}}var E=e.i(88744);let x=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/circuit-breaker/route",pathname:"/api/circuit-breaker",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/circuit-breaker/route.js",nextConfigOutput:"standalone",userland:E}),{workAsyncStorage:N,workUnitAsyncStorage:S,serverHooks:y}=x;function A(){return(0,s.patchFetch)({workAsyncStorage:N,workUnitAsyncStorage:S})}async function k(e,t,s){var C;let w="/api/circuit-breaker/route";w=w.replace(/\/index$/,"")||"/";let R=await x.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==s.waitUntil||s.waitUntil.call(s,Promise.resolve()),null;let{buildId:v,params:O,nextConfig:E,isDraftMode:N,prerenderManifest:S,routerServerContext:y,isOnDemandRevalidate:A,revalidateOnlyGenerated:k,resolvedPathname:T}=R,b=(0,n.normalizeAppPath)(w),P=!!(S.dynamicRoutes[b]||S.routes[T]);if(P&&!N){let e=!!S.routes[T],t=S.dynamicRoutes[b];if(t&&!1===t.fallback&&!e)throw new g.NoFallbackError}let D=null;!P||x.isDev||N||(D="/index"===(D=T)?"/":D);let H=!0===x.isDev||!P,_=P&&!H,F=e.method||"GET",$=(0,i.getTracer)(),M=$.getActiveScopeSpan(),j={params:O,prerenderManifest:S,renderOpts:{experimental:{cacheComponents:!!E.experimental.cacheComponents,authInterrupts:!!E.experimental.authInterrupts},supportsDynamicResponse:H,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:null==(C=E.experimental)?void 0:C.cacheLife,isRevalidate:_,waitUntil:s.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,s)=>x.onRequestError(e,t,s,y)},sharedContext:{buildId:v}},I=new l.NodeNextRequest(e),L=new l.NodeNextResponse(t),U=o.NextRequestAdapter.fromNodeNextRequest(I,(0,o.signalFromNodeResponse)(t));try{let n=async r=>x.handle(U,j).finally(()=>{if(!r)return;r.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let s=$.getRootSpanAttributes();if(!s)return;if(s.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${s.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=s.get("next.route");if(a){let e=`${F} ${a}`;r.setAttributes({"next.route":a,"http.route":a,"next.span_name":e}),r.updateName(e)}else r.updateName(`${F} ${e.url}`)}),l=async i=>{var l,o;let c=async({previousCacheEntry:r})=>{try{if(!(0,a.getRequestMeta)(e,"minimalMode")&&A&&k&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let l=await n(i);e.fetchMetrics=j.renderOpts.fetchMetrics;let o=j.renderOpts.pendingWaitUntil;o&&s.waitUntil&&(s.waitUntil(o),o=void 0);let c=j.renderOpts.collectedTags;if(!P)return await (0,h.sendResponse)(I,L,l,j.renderOpts.pendingWaitUntil),null;{let e=await l.blob(),t=(0,d.toNodeOutgoingHttpHeaders)(l.headers);c&&(t[f.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==j.renderOpts.collectedRevalidate&&!(j.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&j.renderOpts.collectedRevalidate,s=void 0===j.renderOpts.collectedExpire||j.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:j.renderOpts.collectedExpire;return{value:{kind:m.CachedRouteKind.APP_ROUTE,status:l.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:s}}}}catch(t){throw(null==r?void 0:r.isStale)&&await x.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isRevalidate:_,isOnDemandRevalidate:A})},y),t}},g=await x.handleResponse({req:e,nextConfig:E,cacheKey:D,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:k,responseGenerator:c,waitUntil:s.waitUntil});if(!P)return null;if((null==g||null==(l=g.value)?void 0:l.kind)!==m.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==g||null==(o=g.value)?void 0:o.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,a.getRequestMeta)(e,"minimalMode")||t.setHeader("x-nextjs-cache",A?"REVALIDATED":g.isMiss?"MISS":g.isStale?"STALE":"HIT"),N&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let C=(0,d.fromNodeOutgoingHttpHeaders)(g.value.headers);return(0,a.getRequestMeta)(e,"minimalMode")&&P||C.delete(f.NEXT_CACHE_TAGS_HEADER),!g.cacheControl||t.getHeader("Cache-Control")||C.get("Cache-Control")||C.set("Cache-Control",(0,p.getCacheControlHeader)(g.cacheControl)),await (0,h.sendResponse)(I,L,new Response(g.value.body,{headers:C,status:g.value.status||200})),null};M?await l(M):await $.withPropagatedContext(e.headers,()=>$.trace(c.BaseServerSpan.handleRequest,{spanName:`${F} ${e.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},l))}catch(t){if(M||t instanceof g.NoFallbackError||await x.onRequestError(e,t,{routerKind:"App Router",routePath:b,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isRevalidate:_,isOnDemandRevalidate:A})}),P)throw t;return await (0,h.sendResponse)(I,L,new Response(null,{status:500})),null}}}];

//# sourceMappingURL=_9e2ce198._.js.map