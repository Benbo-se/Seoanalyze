{"version":3,"sources":["turbopack:///[project]/src/utils/pushNotifications.js"],"sourcesContent":["// Push Notifications utility for Next.js app\n\nconst VAPID_PUBLIC_KEY = 'BEffMaVuuKK12Yl5mulPU99ZShnk-0l_gbOuNVtidI0zOQsxJNQFQsP4vTfYHkUqTswmvOMfAscLZf5NkrPTgmk'; // Production key\n\n/**\n * Request notification permission from user\n * @returns {Promise<NotificationPermission>}\n */\nexport async function requestNotificationPermission() {\n  if (!('Notification' in window)) {\n    console.warn('This browser does not support notifications');\n    return 'denied';\n  }\n\n  if (Notification.permission === 'granted') {\n    return 'granted';\n  }\n\n  if (Notification.permission === 'denied') {\n    return 'denied';\n  }\n\n  // Request permission\n  const permission = await Notification.requestPermission();\n  console.log('Notification permission:', permission);\n  return permission;\n}\n\n/**\n * Subscribe user to push notifications\n * @param {ServiceWorkerRegistration} registration \n * @returns {Promise<PushSubscription|null>}\n */\nexport async function subscribeToPushNotifications(registration) {\n  try {\n    const permission = await requestNotificationPermission();\n    \n    if (permission !== 'granted') {\n      console.warn('Notification permission not granted');\n      return null;\n    }\n\n    // Check if already subscribed\n    const existingSubscription = await registration.pushManager.getSubscription();\n    if (existingSubscription) {\n      console.log('Already subscribed to push notifications');\n      return existingSubscription;\n    }\n\n    // Convert VAPID key to Uint8Array\n    const vapidKey = urlBase64ToUint8Array(VAPID_PUBLIC_KEY);\n\n    // Subscribe to push notifications\n    const subscription = await registration.pushManager.subscribe({\n      userVisibleOnly: true,\n      applicationServerKey: vapidKey\n    });\n\n    console.log('Successfully subscribed to push notifications:', subscription);\n    \n    // Send subscription to server\n    await sendSubscriptionToServer(subscription);\n    \n    return subscription;\n  } catch (error) {\n    console.error('Failed to subscribe to push notifications:', error);\n    return null;\n  }\n}\n\n/**\n * Unsubscribe from push notifications\n * @param {ServiceWorkerRegistration} registration \n * @returns {Promise<boolean>}\n */\nexport async function unsubscribeFromPushNotifications(registration) {\n  try {\n    const subscription = await registration.pushManager.getSubscription();\n    \n    if (!subscription) {\n      console.log('No subscription found');\n      return true;\n    }\n\n    const successful = await subscription.unsubscribe();\n    \n    if (successful) {\n      console.log('Successfully unsubscribed from push notifications');\n      // Notify server about unsubscription\n      await removeSubscriptionFromServer(subscription);\n    }\n    \n    return successful;\n  } catch (error) {\n    console.error('Failed to unsubscribe from push notifications:', error);\n    return false;\n  }\n}\n\n/**\n * Send subscription to server for storage\n * @param {PushSubscription} subscription \n */\nasync function sendSubscriptionToServer(subscription) {\n  try {\n    const response = await fetch('/api/push/subscribe', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        subscription,\n        timestamp: Date.now()\n      })\n    });\n    \n    if (!response.ok) {\n      console.warn('Failed to save subscription to server');\n    }\n  } catch (error) {\n    console.error('Error sending subscription to server:', error);\n  }\n}\n\n/**\n * Remove subscription from server\n * @param {PushSubscription} subscription \n */\nasync function removeSubscriptionFromServer(subscription) {\n  try {\n    const response = await fetch('/api/push/unsubscribe', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        subscription\n      })\n    });\n    \n    if (!response.ok) {\n      console.warn('Failed to remove subscription from server');\n    }\n  } catch (error) {\n    console.error('Error removing subscription from server:', error);\n  }\n}\n\n/**\n * Convert base64 VAPID key to Uint8Array\n * @param {string} base64String \n * @returns {Uint8Array}\n */\nfunction urlBase64ToUint8Array(base64String) {\n  const padding = '='.repeat((4 - base64String.length % 4) % 4);\n  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');\n  const rawData = window.atob(base64);\n  const outputArray = new Uint8Array(rawData.length);\n  \n  for (let i = 0; i < rawData.length; ++i) {\n    outputArray[i] = rawData.charCodeAt(i);\n  }\n  \n  return outputArray;\n}\n\n/**\n * Show notification when analysis is complete\n * @param {string} jobId \n * @param {string} analysisType \n * @param {string} url \n * @param {number} score \n */\nexport async function showAnalysisCompleteNotification(jobId, analysisType, url, score) {\n  if (!('Notification' in window) || Notification.permission !== 'granted') {\n    return;\n  }\n\n  const notificationTitle = 'Analys komplett!';\n  const notificationBody = `Din ${analysisType.toUpperCase()}-analys av ${url} Ã¤r klar. Score: ${score}`;\n  const notificationIcon = '/icons/icon-192x192.png';\n  \n  const notification = new Notification(notificationTitle, {\n    body: notificationBody,\n    icon: notificationIcon,\n    badge: '/icons/icon-72x72.png',\n    vibrate: [200, 100, 200],\n    data: {\n      jobId,\n      analysisType,\n      url,\n      score\n    },\n    actions: [\n      {\n        action: 'view',\n        title: 'Visa resultat'\n      }\n    ],\n    requireInteraction: true,\n    tag: 'analysis-complete'\n  });\n\n  notification.addEventListener('click', () => {\n    window.focus();\n    window.location.href = `/analys/${jobId}`;\n    notification.close();\n  });\n\n  // Auto-close after 10 seconds\n  setTimeout(() => {\n    notification.close();\n  }, 10000);\n}\n\n/**\n * Queue analysis for background sync when offline\n * @param {object} analysisData \n * @returns {Promise<string|null>}\n */\nexport async function queueAnalysisForBackgroundSync(analysisData) {\n  if (!('serviceWorker' in navigator) || !navigator.serviceWorker.controller) {\n    console.warn('Service Worker not available for background sync');\n    return null;\n  }\n\n  try {\n    const messageChannel = new MessageChannel();\n    \n    return new Promise((resolve, reject) => {\n      messageChannel.port1.onmessage = (event) => {\n        if (event.data.success) {\n          resolve(event.data.analysisId);\n        } else {\n          reject(new Error('Failed to queue analysis'));\n        }\n      };\n\n      navigator.serviceWorker.controller.postMessage({\n        type: 'QUEUE_ANALYSIS',\n        analysisData,\n        analysisId: Date.now().toString()\n      }, [messageChannel.port2]);\n    });\n  } catch (error) {\n    console.error('Error queuing analysis for background sync:', error);\n    return null;\n  }\n}\n\n/**\n * Check if push notifications are supported and enabled\n * @returns {Promise<{supported: boolean, permission: NotificationPermission, subscribed: boolean}>}\n */\nexport async function getPushNotificationStatus() {\n  const supported = 'Notification' in window && 'serviceWorker' in navigator && 'PushManager' in window;\n  \n  if (!supported) {\n    return { supported: false, permission: 'denied', subscribed: false };\n  }\n\n  const permission = Notification.permission;\n  let subscribed = false;\n\n  try {\n    const registration = await navigator.serviceWorker.ready;\n    const subscription = await registration.pushManager.getSubscription();\n    subscribed = !!subscription;\n  } catch (error) {\n    console.error('Error checking subscription status:', error);\n  }\n\n  return { supported, permission, subscribed };\n}"],"names":[],"mappings":"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"}