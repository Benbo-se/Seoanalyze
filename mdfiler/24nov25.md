# BUGFIXAR 24 NOVEMBER 2025

## üéØ Sammanfattning
Fixade tre kritiska buggar:
1. Redis-anslutningsfel i API
2. Argus Metrics dom√§nbyte
3. Lighthouse k√∂rade bara 2 av 4 kategorier

---

## üêõ Bug #1: Redis-anslutningsfel

### Problem
```
Failed to create analysis: ReferenceError: redis is not defined
```

API-routen `/api/v1/analyses` kunde inte skapa analyser pga undefined `redis` variabel.

### Root Cause
**Fil:** `src/app/api/v1/analyses/route.js` (rad 88)
```javascript
const queue = new Queue(queueName, { connection: redis }); // ‚ùå redis inte definierad
```

### Fix
```javascript
const queue = new Queue(queueName, { connection: getRedis() }); // ‚úÖ Anv√§nd getRedis() ist√§llet
```

### Verifiering
```bash
curl -s -X POST https://seoanalyze.se/api/v1/analyses \
  -H "Content-Type: application/json" \
  -d '{"url":"https://example.com","analysisType":"lighthouse"}' | jq .
# ‚úÖ Returnerar: {"id": "...", "jobId": "...", "type": "lighthouse", "status": "pending"}
```

---

## üêõ Bug #2: Argus Metrics dom√§nbyte

### Problem
Argus Metrics bytte dom√§n fr√•n `argusmetrics.se` till `argusmetrics.io`
- Gammal kod: `https://argusmetrics.se/static/tracker.prod.min.js`
- Ny URL: `https://argusmetrics.io/static/tracker.min.js`
- CSP blockerade nya dom√§nen

### Fixar

#### 1. Uppdaterade CookieBanner.jsx
**Fil:** `src/components/common/CookieBanner.jsx` (rad 90)
```javascript
// F√ñRE
argusScript.src = 'https://argusmetrics.se/static/tracker.prod.min.js';

// EFTER
argusScript.src = 'https://argusmetrics.io/static/tracker.min.js';
```

#### 2. Uppdaterade CSP
**Fil:** `next.config.mjs` (rad 126)
```javascript
// Lade till https://argusmetrics.io i b√•de script-src och connect-src
value: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.sentry-cdn.com https://argusmetrics.se https://argusmetrics.io; ... connect-src 'self' https://sentry.io https://o4507825648566272.ingest.de.sentry.io https://argusmetrics.se https://argusmetrics.io; ..."
```

### Verifiering
```bash
# Rebuild och restart
NODE_ENV=production npm run build
pm2 restart seo-nextjs-prod

# Verifiera CSP
curl -s -I http://localhost:5001 | grep "Content-Security-Policy"
# ‚úÖ Inneh√•ller b√•de argusmetrics.se och argusmetrics.io
```

---

## üêõ Bug #3: Lighthouse k√∂rde bara 2 av 4 kategorier

### Problem
Lighthouse k√∂rde endast `performance` och `seo`, men inte `accessibility` och `best-practices`.

**Resultat F√ñRE fix:**
```json
{
  "performance": 53,
  "accessibility": null,
  "seo": 92,
  "bestPractices": null
}
```

### Root Cause
PM2 hade cachat environment variabeln `LIGHTHOUSE_ONLY_CATEGORIES=performance,seo` i:
1. lighthouse-worker process (ID 8)
2. **seo-nextjs-workers processer (ID 2, 3)** ‚Üê Detta var nyckeln!

### Fixar

#### 1. Kommenterade ENV-variabel
**Filer:** `.env` och `.env.production` (rad 56)
```bash
# F√ñRE
LIGHTHOUSE_ONLY_CATEGORIES=performance,seo

# EFTER
# LIGHTHOUSE_ONLY_CATEGORIES=performance,seo  ‚Üê Disabled to run all 4 categories (performance, accessibility, seo, best-practices)
```

#### 2. Uppdaterade ecosystem.config.js
**Fil:** `ecosystem.config.js`

**lighthouse-worker (rad 77):**
```javascript
env: {
  NODE_ENV: 'production',
  LIGHTHOUSE_WORKER_PORT: '5002',
  LIGHTHOUSE_TIMEOUT_MS: '90000',
  LIGHTHOUSE_CACHE_TTL_MS: '600000',
  LIGHTHOUSE_CONCURRENCY: '3',
  LIGHTHOUSE_ONLY_CATEGORIES: ''  // Tom str√§ng = anv√§nd default (alla 4 kategorier)
}
```

**seo-nextjs-workers (rad 53 - NYA RADEN!):**
```javascript
env: {
  NODE_ENV: 'production',
  // ... andra variabler
  LIGHTHOUSE_ONLY_CATEGORIES: ''  // Tom str√§ng = anv√§nd default (alla 4 kategorier)
}
```

#### 3. Restart alla processer
```bash
# Restart lighthouse-worker
pm2 restart lighthouse-worker

# Restart workers (KRITISKT!)
pm2 delete seo-nextjs-workers
pm2 start ecosystem.config.js --only seo-nextjs-workers
pm2 save

# Verifiera environment
pm2 env 11 | grep LIGHTHOUSE_ONLY_CATEGORIES
# ‚úÖ Visar: LIGHTHOUSE_ONLY_CATEGORIES: (tom)
```

### Verifiering

#### Test 1: Lighthouse-worker direkt
```bash
curl -s -X POST http://localhost:5002/run \
  -H "Content-Type: application/json" \
  -d '{"url":"https://bbc.com"}' | jq '.data | {performance, accessibility, seo, bestPractices}'
```
**Resultat:**
```json
{
  "performance": 28,
  "accessibility": 88,
  "seo": 100,
  "bestPractices": 79
}
```
‚úÖ Alla 4 scores!

#### Test 2: Via API (production)
```bash
curl -s -X POST https://seoanalyze.se/api/v1/analyses \
  -H "Content-Type: application/json" \
  -d '{"url":"https://example.com","analysisType":"lighthouse"}' | jq -r '.id'
# Resultat: 01KAVBQQ0JEVNWC3FNJWRQH1HC

sleep 30

curl -s "https://seoanalyze.se/api/v1/analyses/01KAVBQQ0JEVNWC3FNJWRQH1HC" \
  | jq '{status: .status, performance: .results.performance, accessibility: .results.accessibility, seo: .results.seo, bestPractices: .results.bestPractices}'
```

**Resultat:**
```json
{
  "status": "completed",
  "performance": 100,
  "accessibility": 100,
  "seo": 80,
  "bestPractices": 93
}
```
‚úÖ Alla 4 scores!

#### Test 3: Stripe.com
```json
{
  "status": "completed",
  "performance": 36,
  "accessibility": 92,
  "seo": 100,
  "bestPractices": 100
}
```
‚úÖ Alla 4 scores!

---

## üìù Viktiga l√§rdomar

### 1. PM2 Environment Caching
PM2 cachar environment variabler √§ven n√§r man uppdaterar .env-filer. Man m√•ste:
- Uppdatera `ecosystem.config.js`
- K√∂ra `pm2 delete` + `pm2 start` (inte bara `pm2 restart`)
- Verifiera med `pm2 env <process_id>`

### 2. Workers k√∂r Lighthouse direkt
`seo-nextjs-workers` k√∂r `new LighthouseAnalyzer()` direkt i `lib/queue-workers.js` (rad 269), vilket betyder att de l√§ser environment variabeln direkt - inte via HTTP till lighthouse-worker.

Detta inneb√§r att **b√•da** processerna beh√∂ver ha r√§tt environment:
- `lighthouse-worker` (f√∂r HTTP-endpoint)
- `seo-nextjs-workers` (f√∂r queue-jobs)

### 3. Lighthouse-analyzer.js default behavior
```javascript
// lighthouse-analyzer.js rad 127-130
const defaultCategories = ['performance', 'accessibility', 'seo', 'best-practices'];
const onlyCategories = process.env.LIGHTHOUSE_ONLY_CATEGORIES
  ? process.env.LIGHTHOUSE_ONLY_CATEGORIES.split(',').map(c => c.trim())
  : defaultCategories;  // ‚Üê K√∂r alla 4 om ENV var saknas eller √§r tom
```

S√• en tom str√§ng `''` √§r samma som undefined - b√•da k√∂r alla 4 kategorier.

---

## ‚úÖ Status

### F√∂re bugfixar:
- ‚ùå API kunde inte skapa analyser (Redis-fel)
- ‚ùå Argus Metrics laddades inte (fel dom√§n)
- ‚ùå Lighthouse k√∂rde bara 2/4 kategorier

### Efter bugfixar:
- ‚úÖ API skapar analyser korrekt
- ‚úÖ Argus Metrics fungerar med nya dom√§nen
- ‚úÖ Lighthouse k√∂r alla 4 kategorier
- ‚úÖ Frontend visar alla scores korrekt
- ‚úÖ Verifierat med 3 olika webbplatser (example.com, stripe.com, bbc.com)

---

## üîÑ Deployment Steps (f√∂r framtiden)

Om Lighthouse-kategorier beh√∂ver √§ndras:

```bash
# 1. Uppdatera ecosystem.config.js (B√ÖDA processer!)
vim ecosystem.config.js
# - Uppdatera lighthouse-worker env
# - Uppdatera seo-nextjs-workers env

# 2. Restart lighthouse-worker
pm2 restart lighthouse-worker

# 3. Restart workers (VIKTIGT: delete f√∂rst!)
pm2 delete seo-nextjs-workers
pm2 start ecosystem.config.js --only seo-nextjs-workers
pm2 save

# 4. Verifiera
pm2 env 8 | grep LIGHTHOUSE_ONLY_CATEGORIES  # lighthouse-worker
pm2 env 11 | grep LIGHTHOUSE_ONLY_CATEGORIES # workers instance 1
pm2 env 12 | grep LIGHTHOUSE_ONLY_CATEGORIES # workers instance 2

# 5. Test
curl -X POST https://seoanalyze.se/api/v1/analyses \
  -H "Content-Type: application/json" \
  -d '{"url":"https://example.com","analysisType":"lighthouse"}'
```

---

**Datum:** 2024-11-24
**Status:** ‚úÖ Alla buggar fixade
**Verifierat:** Production (seoanalyze.se)
**N√§sta steg:** Testa AI-analys
